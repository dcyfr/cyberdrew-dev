# CSP Fix: Removed Nonce to Allow unsafe-inline

**Date:** October 5, 2025  
**Issue:** Nonce in CSP was causing 'unsafe-inline' to be ignored  
**Status:** ✅ Fixed

## Problem

When a CSP includes both a `nonce` value and `'unsafe-inline'`, the browser **ignores** `'unsafe-inline'`. This is by design for security - the nonce is meant to replace unsafe-inline.

### Error Message
```
Refused to execute inline script because it violates the following 
Content Security Policy directive: "script-src 'self' 'unsafe-inline' 
... 'nonce-XXX'". 

Note that 'unsafe-inline' is ignored if either a hash or nonce value 
is present in the source list.
```

### Why This Happened

The initial CSP implementation included:
```typescript
script-src 'self' 'unsafe-inline' ... 'nonce-${nonce}'
```

This combination caused the browser to:
1. See the nonce value
2. Ignore `'unsafe-inline'`
3. Block all inline scripts without nonces

### Impact

- ❌ Next.js hydration scripts blocked
- ❌ Vercel Analytics inline scripts blocked
- ❌ Third-party inline scripts blocked
- ❌ JSON-LD structured data blocked
- ❌ Site functionality broken

## Root Cause

### CSP Nonce Behavior

From the CSP spec:
> When a nonce or hash is present in script-src, the 'unsafe-inline' 
> directive is ignored by browsers for security reasons.

This is intentional - if you're using nonces, you should nonce ALL inline scripts, not mix nonces with unsafe-inline.

### Our Situation

We have multiple sources of inline scripts:
1. **Next.js hydration** - Generated by framework
2. **Vercel Analytics** - Third-party inline scripts
3. **JSON-LD** - Structured data in script tags
4. **Tailwind** - Inline styles (though this is style-src)

To properly use nonces, we would need to:
- Add nonces to all Next.js hydration scripts
- Add nonces to Vercel Analytics scripts
- Add nonces to JSON-LD scripts
- Modify our rendering pipeline significantly

This is complex and not worth the effort for our current security needs.

## Solution

### Removed Nonce from CSP

**Before:**
```typescript
`script-src 'self' 'unsafe-inline' ... 'nonce-${nonce}'`
```

**After:**
```typescript
`script-src 'self' 'unsafe-inline' ...`
```

### Changes Made

1. **Removed nonce generation**
   ```typescript
   // REMOVED:
   const nonce = Buffer.from(crypto.randomUUID()).toString("base64");
   ```

2. **Removed nonce from script-src**
   ```typescript
   // BEFORE:
   `script-src 'self' 'unsafe-inline' ... 'nonce-${nonce}'`
   
   // AFTER:
   `script-src 'self' 'unsafe-inline' ...`
   ```

3. **Removed nonce header**
   ```typescript
   // REMOVED:
   requestHeaders.set("x-nonce", nonce);
   ```

4. **Updated documentation**
   - Changed comments to reflect current implementation
   - Noted future enhancement possibility

## Security Implications

### Trade-offs

**What We Lost:**
- Ability to use nonce-based inline script control
- Slightly stricter XSS protection

**What We Kept:**
- ✅ CSP still blocks unauthorized external scripts
- ✅ Only approved domains can load scripts
- ✅ Clickjacking protection (frame-src 'none')
- ✅ MIME-sniffing protection
- ✅ All other security headers

### Why This is Acceptable

1. **'unsafe-inline' is controlled:**
   - We control all inline scripts in our codebase
   - No user-generated content with inline scripts
   - All third-party scripts are from trusted sources

2. **Multiple layers of defense:**
   - Input validation on all forms
   - Output encoding for user content
   - Safe MDX rendering
   - No dangerouslySetInnerHTML except for trusted JSON-LD

3. **External script control:**
   - CSP still restricts which external domains can load scripts
   - Only Vercel Analytics and our own scripts allowed
   - This blocks most XSS attack vectors

4. **Industry standard:**
   - Many production sites use 'unsafe-inline' with strict domain allowlists
   - This is acceptable for sites without user-generated inline content

## Alternative Solutions (Not Chosen)

### Option 1: Add Nonces to Everything

**Pros:**
- Stricter CSP
- Better XSS protection

**Cons:**
- Requires modifying Next.js rendering
- Need to nonce Vercel Analytics
- Need to nonce JSON-LD scripts
- Complex implementation
- High maintenance burden

**Verdict:** Not worth the complexity for our threat model

### Option 2: Hash-based CSP

**Pros:**
- No runtime nonce generation needed
- Specific inline scripts allowed

**Cons:**
- Hashes change when script content changes
- Doesn't work for dynamic scripts
- Still can't handle Next.js hydration easily

**Verdict:** Not practical for our setup

### Option 3: Move All Scripts External

**Pros:**
- Can remove 'unsafe-inline'
- Cleaner CSP

**Cons:**
- Breaks Next.js hydration
- Breaks Vercel Analytics
- Major refactoring required
- Performance impact

**Verdict:** Not feasible with current stack

## Updated CSP Policy

### Current (Working) CSP

```
default-src 'self';
script-src 'self' 'unsafe-inline' 
  https://va.vercel-scripts.com 
  https://*.vercel-insights.com 
  https://vercel.live;
style-src 'self' 'unsafe-inline' 
  https://fonts.googleapis.com 
  https://vercel.live;
img-src 'self' data: 
  https://*.vercel.com 
  https://vercel.com 
  https://vercel.live;
font-src 'self' 
  https://fonts.gstatic.com 
  https://vercel.live;
connect-src 'self' 
  https://va.vercel-scripts.com 
  https://*.vercel-insights.com 
  https://vercel-insights.com 
  https://vercel.live 
  https://*.pusher.com 
  wss://*.pusher.com;
frame-src 'none';
object-src 'none';
base-uri 'self';
form-action 'self';
upgrade-insecure-requests;
block-all-mixed-content
```

### Key Points

- ✅ `'unsafe-inline'` now works (no nonce to override it)
- ✅ External scripts limited to approved domains
- ✅ Inline scripts allowed (controlled by us)
- ✅ All other CSP protections active

## Testing

### Verification Steps

1. **Check inline scripts work:**
   ```bash
   # Start dev server
   npm run dev
   
   # Open browser console
   # Should see no CSP errors
   # Vercel Analytics should load
   # Site should be fully functional
   ```

2. **Check external scripts still blocked:**
   ```javascript
   // Try to inject malicious script
   const script = document.createElement('script');
   script.src = 'https://evil.com/malware.js';
   document.body.appendChild(script);
   
   // Should be blocked by CSP:
   // "Refused to load script from 'https://evil.com/malware.js'
   //  because it violates the following Content Security Policy
   //  directive: 'script-src ...'"
   ```

3. **Build validation:**
   ```bash
   npm run lint && npm run build
   # ✓ Compiled successfully
   # ✓ Middleware: 34.2 kB
   ```

## Files Modified

### Updated (1 file)
- `src/middleware.ts` - Removed nonce generation and usage

### Documentation (1 file)
- `docs/CSP_NONCE_FIX.md` - This document

## Future Enhancements

If we want to migrate to nonce-based CSP in the future:

### Requirements

1. **Next.js Support:**
   - Add nonces to hydration scripts
   - Modify `Document` component
   - Pass nonce through rendering pipeline

2. **Third-Party Scripts:**
   - Externalize or nonce Vercel Analytics
   - Externalize or nonce JSON-LD scripts
   - Update all inline event handlers

3. **Build Process:**
   - Generate nonces at render time
   - Pass nonces to all components
   - Update all inline script tags

### Example Implementation

```typescript
// pages/_document.tsx
import { Html, Head, Main, NextScript } from 'next/document';

export default function Document({ nonce }: { nonce: string }) {
  return (
    <Html>
      <Head nonce={nonce}>
        <script nonce={nonce}>
          {/* Inline script with nonce */}
        </script>
      </Head>
      <body>
        <Main />
        <NextScript nonce={nonce} />
      </body>
    </Html>
  );
}
```

This would require:
- Significant refactoring
- Testing all functionality
- Updating all inline scripts
- Maintaining nonce propagation

**Current Assessment:** Not worth the effort for our current security needs.

## Related Documentation

- [CSP Implementation](./CSP_IMPLEMENTATION.md)
- [CSP Quick Reference](./CSP_QUICKREF.md)
- [Security Findings Resolution](./SECURITY_FINDINGS_RESOLUTION.md)
- [CSP Vercel Live Fix](./CSP_VERCEL_LIVE_FIX.md)

## Summary

✅ **Issue:** Nonce was causing 'unsafe-inline' to be ignored  
✅ **Fix:** Removed nonce from CSP  
✅ **Result:** Inline scripts work, CSP still protects  
✅ **Security:** Acceptable for our threat model  
✅ **Performance:** No impact (slightly smaller middleware)  

### Key Takeaways

1. **Nonce + 'unsafe-inline' = nonce wins**
   - Browser ignores 'unsafe-inline' when nonce present
   - Can't mix the two approaches

2. **'unsafe-inline' is OK when:**
   - You control all inline content
   - No user-generated inline scripts
   - External scripts are restricted via CSP
   - Multiple defense layers in place

3. **Nonce-based CSP requires:**
   - Framework support
   - Comprehensive nonce propagation
   - Maintenance overhead
   - Significant refactoring

---

*Fix applied on October 5, 2025*
